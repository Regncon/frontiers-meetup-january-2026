package root

import (
	"database/sql"
	"fmt"

	"github.com/Regncon/frontiers-meetup-january-2026/slides"
)

type slideFunc func() templ.Component

func deck(
	db *sql.DB,
	inviteKey string,
	sessionID string,
	isPresenter bool,
	localKey string,
	remoteKey string,
) []slideFunc {
	poll := MustPoll("dom-checkbox-limit")
	pollConcurrency := MustPoll("regncon-concurrency")

	return []slideFunc{
		func() templ.Component { return slides.LobbyWelcome(isPresenter) },
		func() templ.Component { return slides.WhyThisTalk(isPresenter) },

		func() templ.Component { return slides.Agenda(slides.AgendaWhoWeAre, isPresenter) },
		func() templ.Component { return slides.WhatIsRegncon(isPresenter) },
		func() templ.Component { return slides.ProjectVision(isPresenter) },
		func() templ.Component { return slides.WhoWeAre(isPresenter) },
		func() templ.Component { return slides.DifferentViewpoints(isPresenter) },

		func() templ.Component { return slides.Agenda(slides.Agenda2024, isPresenter) },
		func() templ.Component { return slides.Build2024Philosophy(isPresenter) },
		//func() templ.Component { return slides.WhatIsNextJS(isPresenter) },
		//func() templ.Component { return slides.WhatIsFirebase(isPresenter) },
		func() templ.Component { return slides.Build2024Snapshot(isPresenter) },
		func() templ.Component { return slides.Build2024HowDidItGo(isPresenter) },

		func() templ.Component { return slides.Agenda(slides.Agenda2025, isPresenter) },
		func() templ.Component { return slides.Build2025Philosophy(isPresenter) },
		func() templ.Component { return slides.GrugBrainMeme(isPresenter) },
		func() templ.Component { return slides.Build2025HowWeChoseTheStack(isPresenter) },
		//func() templ.Component { return slides.WhatIsGo(isPresenter) },
		func() templ.Component { return slides.WhatIsTempl(isPresenter) },

		func() templ.Component { return slides.WhatIsDatastar(isPresenter) },
		func() templ.Component { return slides.DatastarCheckboxTrickSetup(isPresenter) },
		func() templ.Component { return PollSlide(db, inviteKey, sessionID, poll) },
		func() templ.Component { return PollResultsSlide(db, poll, localKey, remoteKey) },
		func() templ.Component { return slides.DatastarCheckboxTrickReveal(isPresenter) },
		func() templ.Component { return slides.DatastarCheckboxTrickDemo(isPresenter) },
		//func() templ.Component { return slides.WhatIsSQLite(isPresenter) },
		//func() templ.Component { return slides.WhatIsNATS(isPresenter) },
		func() templ.Component { return slides.Build2025Snapshot(isPresenter) },
		func() templ.Component { return slides.Build2025HowDidItGoQuestion(isPresenter) },
		func() templ.Component { return slides.Build2025ServerExplosion(isPresenter) },
		func() templ.Component { return slides.Build2025HowDidItGo(isPresenter) },

		func() templ.Component { return slides.Agenda(slides.AgendaCompare, isPresenter) },
		func() templ.Component { return slides.Stack2024GoodBad(isPresenter) },
		func() templ.Component { return slides.NextJSCVE202555182Impact(isPresenter) },
		func() templ.Component { return slides.Stack2025GoodBad(isPresenter) },

		func() templ.Component { return slides.RegnconConcurrencyPollSetup(isPresenter) },
		func() templ.Component { return PollSlide(db, inviteKey, sessionID, pollConcurrency) },
		func() templ.Component { return PollResultsSlide(db, pollConcurrency, localKey, remoteKey) },
		func() templ.Component { return slides.RegnconConcurrencyPollReveal(isPresenter) },

		func() templ.Component { return slides.LanguageGoKOSlide(isPresenter) },
		func() templ.Component { return slides.LanguageGoWins(isPresenter) },
		func() templ.Component { return slides.LanguageGoNotPerfect(isPresenter) },
		func() templ.Component { return slides.LanguageGoErrorHandling(isPresenter) },
		func() templ.Component { return slides.LanguageJSTSWins(isPresenter) },
		func() templ.Component { return slides.ComplexityEssentialVsAccidental(isPresenter) },

		func() templ.Component { return slides.StylingGoodBad(isPresenter) },
		func() templ.Component { return slides.ToolingDXKOSlide(isPresenter) },
		func() templ.Component { return slides.ToolingAndDXGoodBad(isPresenter) },
		func() templ.Component { return slides.LLMAssistanceGoodBad(isPresenter) },
		func() templ.Component { return slides.Agenda(slides.AgendaWhatsNext, isPresenter) },
		func() templ.Component { return slides.WhatsNext2026_2027(isPresenter) },
	}
}

func deckSize() int {
	// Only used for clamping; closures won't be executed.
	return len(deck(nil, "", "", true, "", ""))
}

func clampSlideIndex(index int) int {
	if index < 0 {
		return 0
	}

	size := deckSize()
	if size == 0 {
		return 0
	}

	if index >= size {
		return size - 1
	}

	return index
}

func slideAt(deck []slideFunc, index int) slideFunc {
	if index < 0 || index >= len(deck) {
		return func() templ.Component { return UnknownSlide() }
	}
	return deck[index]
}

// --- Components ---
templ ActiveSlide(
	db *sql.DB,
	inviteKey string,
	sessionID string,
	isPresenter bool,
	localKey string,
	remoteKey string,
) {
	{{ index, _ := GetCurrentSlideIndex(db) }}
	{{ deckLocal := deck(db, inviteKey, sessionID, isPresenter, localKey, remoteKey) }}
	{{ index = clampSlideIndex(index) }}
	{{ slideComponent := slideAt(deckLocal, index) }}
	<div data-signals={ fmt.Sprintf("{ slideIndex: %d }", index) }>
		@slideComponent()
	</div>
}

templ UnknownSlide() {
	<p>Unknown slide</p>
}
